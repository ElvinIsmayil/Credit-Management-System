@using Humanizer
@model IEnumerable<CategoryVM>

@{
    ViewData["Title"] = "Categories";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<div class="toolbar mb-5 mb-lg-7" id="kt_toolbar">
    <div class="page-title d-flex flex-column me-3">
        <h1 class="d-flex text-dark fw-bold my-1 fs-3">Category Management</h1>
        <ul class="breadcrumb breadcrumb-dot fw-semibold text-gray-600 fs-7 my-1">
            <li class="breadcrumb-item text-gray-600">
                <a href="/Admin/Dashboard" class="text-gray-600 text-hover-primary">Dashboard</a>
            </li>
            <li class="breadcrumb-item text-gray-600">Categories</li>
        </ul>
    </div>
    <div class="d-flex align-items-center gap-2 gap-lg-3">
        <a href="@Url.Action("Create")" class="btn btn-sm btn-primary">
            <span class="svg-icon svg-icon-2">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect opacity="0.5" x="11.364" y="20.364" width="16" height="2" rx="1" transform="rotate(-90 11.364 20.364)" fill="currentColor" />
                    <rect x="4.36396" y="11.364" width="16" height="2" rx="1" fill="currentColor" />
                </svg>
            </span>
            Add Category
        </a>
    </div>
</div>
<div class="card bg-white shadow-md rounded-lg p-6">
    <div class="card-header border-0 pt-6 flex flex-col sm:flex-row justify-between items-start sm:items-center pb-6">
        <div class="card-title mb-4 sm:mb-0">
            <div class="d-flex align-items-center position-relative my-1">
                <span class="svg-icon svg-icon-1 position-absolute ms-6 w-5 h-5 absolute ml-3 text-gray-400">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect opacity="0.5" x="17.0365" y="15.1223" width="8.15546" height="2" rx="1" transform="rotate(45 17.0365 15.1223)" fill="currentColor" />
                        <path d="M11 19C6.55556 19 3 15.4444 3 11C3 6.55556 6.55556 3 11 3C15.4444 3 19 6.55556 19 11C19 15.4444 15.4444 19 11 19ZM11 5C7.53333 5 5 7.53333 5 11C5 14.4667 7.53333 17 11 17C14.4667 17 17 14.4667 17 11C17 7.53333 14.4667 5 11 5Z" fill="currentColor" />
                    </svg>
                </span>
                <input type="text" data-kt-category-table-filter="search" class="form-control form-control-solid w-full sm:w-64 pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Search categories..." />
            </div>
        </div>
        <div class="card-toolbar flex justify-end" data-kt-category-table-toolbar="base">
            <button type="button" class="btn btn-light-primary me-3 inline-flex items-center px-4 py-2 bg-blue-100 text-blue-800 text-sm font-medium rounded-md shadow-sm hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" data-bs-toggle="modal" data-bs-target="#kt_categories_export_modal">
                <span class="svg-icon svg-icon-2 w-5 h-5 mr-2">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect opacity="0.3" x="12.75" y="4.25" width="12" height="2" rx="1" transform="rotate(90 12.75 4.25)" fill="currentColor" />
                        <path d="M12.0573 6.11875L13.5203 7.87435C13.9121 8.34457 14.6232 8.37683 15.056 7.94401C15.4457 7.5543 15.4641 6.92836 15.0979 6.51643L12.4974 3.59084C12.0996 3.14332 11.4004 3.14332 11.0026 3.59084L8.40206 6.51643C8.0359 6.92836 8.0543 7.5543 8.44401 7.94401C8.87683 8.37683 9.58785 8.34458 9.9797 7.87435L11.4427 6.11875C11.6026 5.92684 11.8974 5.92684 12.0573 6.11875Z" fill="currentColor" />
                        <path d="M18.75 8.25H17.75C17.1977 8.25 16.75 8.69772 16.75 9.25C16.75 9.80228 17.1977 10.25 17.75 10.25C18.3023 10.25 18.75 10.6977 18.75 11.25V18.25C18.75 18.8023 18.3023 19.25 17.75 19.25H5.75C5.19772 19.25 4.75 18.8023 4.75 18.25V11.25C4.75 10.6977 5.19771 10.25 5.75 10.25C6.30229 10.25 6.75 9.80228 6.75 9.25C6.75 8.69772 6.30229 8.25 5.75 8.25H4.75C3.64543 8.25 2.75 9.14543 2.75 10.25V19.25C2.75 20.3546 3.64543 21.25 4.75 21.25H18.75C19.8546 21.25 20.75 20.3546 20.75 19.25V10.25C20.75 9.14543 19.8546 8.25 18.75 8.25Z" fill="currentColor" />
                    </svg>
                </span>
                Export
            </button>
        </div>
    </div>
    <div class="card-body pt-0 overflow-x-auto">
        <table class="table align-middle table-row-dashed fs-6 gy-5 min-w-full table-auto divide-y divide-gray-200" id="kt_categories_table">
            <thead>
                <tr class="text-start text-gray-400 fw-bold fs-7 text-uppercase gs-0 text-left text-gray-500 font-semibold text-xs uppercase tracking-wider">
                    <th class="min-w-125px py-3 px-4">Name</th>
                    <th class="min-w-125px py-3 px-4">Parent Category</th>
                    <th class="min-w-125px py-3 px-4">Subcategories</th>
                    <th class="min-w-125px py-3 px-4">Status</th>
                    <th class="text-end min-w-100px py-3 px-4">Actions</th>
                </tr>
            </thead>
            <tbody class="fw-semibold text-gray-600 bg-white divide-y divide-gray-200 text-gray-700">
                @foreach (var item in Model)
                {
                    <tr>
                        <td>
                            <div class="d-flex align-items-center py-2">
                                @if (!string.IsNullOrEmpty(item.ImageUrl))
                                {
                                    <div class="symbol symbol-50px me-5 w-12 h-12 flex-shrink-0 rounded-lg overflow-hidden mr-4">
                                        <img src="@item.ImageUrl" class="object-cover w-full h-full" alt="@item.Name" onerror="this.onerror=null;this.src='https://placehold.co/50x50/cccccc/333333?text=N/A';" />
                                    </div>
                                }
                                <div class="d-flex flex-column">
                                    <a href="@Url.Action("Detail", new { id = item.Id })" class="text-gray-800 text-hover-primary mb-1 hover:text-blue-600 font-medium text-sm">@item.Name</a>
                                    <span class="text-gray-500 text-xs">@item.Description.Truncate(50)</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            @if (item.ParentCategoryId.HasValue)
                            {
                                <span class="badge badge-light-primary inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">@item.ParentCategoryName</span>
                            }
                            else
                            {
                                <span class="badge badge-light-dark inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Top Level</span>
                            }
                        </td>
                        <td>
                            <span class="text-gray-600 text-sm">0</span> @* Placeholder for Subcategories - replace with actual count from model if available *@
                        </td>
                        <td>
                            <div class="badge badge-light-success inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Active</div>
                        </td>
                        <td class="text-end">
                            <div class="relative inline-block text-left">
                                <a href="#" class="btn btn-sm btn-light btn-active-light-primary inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" data-kt-menu-trigger="click" data-kt-menu-placement="bottom-end" id="actions-menu-@item.Id" aria-expanded="true" aria-haspopup="true" data-dropdown-toggle="dropdown-menu-@item.Id">
                                    Actions
                                    <span class="svg-icon svg-icon-5 m-0 -mr-1 ml-2 h-5 w-5">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M11.4343 12.7344L7.25 8.55005C6.83579 8.13583 6.16421 8.13584 5.75 8.55005C5.33579 8.96426 5.33579 9.63583 5.75 10.05L11.2929 15.5929C11.6834 15.9835 12.3166 15.9835 12.7071 15.5929L18.25 10.05C18.6642 9.63584 18.6642 8.96426 18.25 8.55005C17.8358 8.13584 17.1642 8.13584 16.75 8.55005L12.5657 12.7344C12.2533 13.0468 11.7467 13.0468 11.4343 12.7344Z" fill="currentColor" />
                                        </svg>
                                    </span>
                                </a>
                                <div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-semibold fs-7 w-125px py-4 origin-top-right absolute right-0 mt-2 w-32 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-10" data-kt-menu="true" role="menu" aria-orientation="vertical" aria-labelledby="actions-menu-@item.Id" data-dropdown-menu="dropdown-menu-@item.Id">
                                    <div class="menu-item px-3 py-1" role="none">
                                        <a href="@Url.Action("Detail", new { id = item.Id })" class="menu-link px-3 text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">View</a>
                                    </div>
                                    <div class="menu-item px-3 py-1" role="none">
                                        <a href="@Url.Action("Update", new { id = item.Id })" class="menu-link px-3 text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">Edit</a>
                                    </div>
                                    <div class="menu-item px-3 py-1" role="none">
                                        <a href="#" class="menu-link px-3 text-red-600 block px-4 py-2 text-sm hover:bg-red-100 delete-category-btn" data-id="@item.Id" data-kt-category-table-filter="delete_row" role="menuitem">Delete</a>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>
<div class="modal fade hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full" id="kt_categories_export_modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-650px relative p-4 w-full max-w-md md:max-w-xl max-h-full">
        <div class="modal-content relative bg-white rounded-lg shadow dark:bg-gray-700">
            <div class="modal-header flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600">
                <h2 class="fw-bold text-xl font-semibold text-gray-900 dark:text-white">Export Categories</h2>
                <div class="btn btn-icon btn-sm btn-active-icon-primary text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-kt-categories-modal-action="close" data-modal-hide="kt_categories_export_modal">
                    <span class="svg-icon svg-icon-1 w-3 h-3">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect opacity="0.5" x="6" y="17.3137" width="16" height="2" rx="1" transform="rotate(-45 6 17.3137)" fill="currentColor" />
                            <rect opacity="0.5" x="7.41422" y="6" width="16" height="2" rx="1" transform="rotate(45 7.41422 6)" fill="currentColor" />
                        </svg>
                    </span>
                </div>
            </div>
            <div class="modal-body scroll-y mx-5 mx-xl-15 my-7 p-4 md:p-5">
                <form id="kt_categories_export_form" class="form space-y-4" action="#">
                    <div class="fv-row mb-10 mb-5">
                        <label class="fs-5 fw-semibold form-label mb-5 block text-gray-700 text-sm font-semibold mb-2">Select Export Format:</label>
                        <select data-control="select2" data-placeholder="Select a format" data-hide-search="true" name="format" class="form-select form-select-solid w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" id="export-format-select">
                            <option value="excel">Excel</option>
                            <option value="pdf">PDF</option>
                            <option value="csv">CSV</option>
                            <option value="print">Print</option>
                        </select>
                    </div>
                    <div class="text-center flex justify-center space-x-4">
                        <button type="reset" class="btn btn-light me-3 px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500" data-kt-categories-modal-action="cancel" data-modal-hide="kt_categories_export_modal">Discard</button>
                        <button type="submit" class="btn btn-primary px-4 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" data-kt-categories-modal-action="submit">
                            <span class="indicator-label">Submit</span>
                            <span class="indicator-progress hidden">
                                Please wait... <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        // Mock data for categories (removed for MVC, as data comes from Model)
        // let categories = [...];

        // Simple truncate function (mimics Humanizer's Truncate)
        function truncate(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        $(document).ready(function () {
            // Initialize Select2 for the export format dropdown
            $('#export-format-select').select2({
                minimumResultsForSearch: Infinity // Hides the search box
            });

            // Initialize DataTables
            const table = $('#kt_categories_table').DataTable({
                // Data will be rendered directly by Razor, DataTables will enhance it
                // No 'data' property needed here as it's not client-side data source
                dom: "<'sm:flex sm:justify-between sm:items-center mb-4'<'sm:w-1/2'l><'sm:w-1/2'f>>" +
                     "<'w-full overflow-x-auto'tr>" +
                     "<'sm:flex sm:justify-between sm:items-center mt-4'<'sm:w-1/2'i><'sm:w-1/2'p>>",
                lengthMenu: [10, 25, 50, 100],
                pageLength: 10,
                language: {
                    'lengthMenu': 'Show _MENU_ entries',
                    'search': 'Search:',
                    'info': 'Showing _START_ to _END_ of _TOTAL_ entries',
                    'infoEmpty': 'Showing 0 to 0 of 0 entries',
                    'infoFiltered': '(filtered from _MAX_ total entries)',
                    'paginate': {
                        'first': 'First',
                        'last': 'Last',
                        'next': 'Next',
                        'previous': 'Previous'
                    }
                },
                columnDefs: [
                    { orderable: false, targets: 4 } // Disable sorting on actions column
                ]
            });

            // Search functionality
            $('[data-kt-category-table-filter="search"]').on('keyup', function () {
                table.search(this.value).draw();
            });

            // Custom dropdown toggle for actions
            $(document).on('click', '[data-dropdown-toggle]', function() {
                const targetId = $(this).data('dropdown-toggle');
                $(`[data-dropdown-menu="${targetId}"]`).toggleClass('hidden');
            });

            // Close dropdowns when clicking outside
            $(document).on('click', function(event) {
                if (!$(event.target).closest('[data-dropdown-toggle], [data-dropdown-menu]').length) {
                    $('[data-dropdown-menu]').addClass('hidden');
                }
            });

            // Delete row functionality
            $(document).on('click', '.delete-category-btn', function (e) {
                e.preventDefault();
                // Close any open dropdown before showing SweetAlert
                $('[data-dropdown-menu]').addClass('hidden');

                const idToDelete = $(this).data('id');

                Swal.fire({
                    text: "Are you sure you want to delete this category?",
                    icon: "warning",
                    showCancelButton: true,
                    buttonsStyling: false,
                    confirmButtonText: "Yes, delete!",
                    cancelButtonText: "No, cancel",
                    customClass: {
                        confirmButton: "px-4 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",
                        cancelButton: "px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"
                    }
                }).then(function (result) {
                    if (result.value) {
                        // AJAX call for actual deletion
                        $.ajax({
                            url: '@Url.Action("Delete")', // This will be resolved by Razor
                            type: 'POST',
                            data: { id: idToDelete },
                            success: function (response) {
                                if (response.success) {
                                    Swal.fire({
                                        text: "Category deleted successfully!",
                                        icon: "success",
                                        buttonsStyling: false,
                                        confirmButtonText: "Ok",
                                        customClass: {
                                            confirmButton: "px-4 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700"
                                        }
                                    }).then(function () {
                                        location.reload(); // Reload page to reflect changes
                                    });
                                } else {
                                    Swal.fire({
                                        text: response.message || "Failed to delete category.",
                                        icon: "error",
                                        buttonsStyling: false,
                                        confirmButtonText: "Ok",
                                        customClass: {
                                            confirmButton: "px-4 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700"
                                        }
                                    });
                                }
                            },
                            error: function(xhr, status, error) {
                                Swal.fire({
                                    text: "An error occurred during deletion. Please try again.",
                                    icon: "error",
                                    buttonsStyling: false,
                                    confirmButtonText: "Ok",
                                    customClass: {
                                        confirmButton: "px-4 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700"
                                    }
                                });
                                console.error("AJAX Error:", status, error, xhr);
                            }
                        });
                    }
                });
            });

            // Modal functionality (basic show/hide for Tailwind)
            $('[data-modal-toggle]').on('click', function() {
                const targetModalId = $(this).data('modal-target');
                $(`#${targetModalId}`).removeClass('hidden').addClass('flex justify-center items-center');
            });

            $('[data-modal-hide]').on('click', function() {
                const targetModalId = $(this).data('modal-hide');
                $(`#${targetModalId}`).addClass('hidden').removeClass('flex justify-center items-center');
            });

            // Export modal form submission
            $('#kt_categories_export_form').on('submit', function (e) {
                e.preventDefault();
                const format = $('[name="format"]').val();

                // Simulate export - in a real app you would make an AJAX call here
                Swal.fire({
                    text: "Exporting categories to " + format.toUpperCase() + "...",
                    icon: "info",
                    buttonsStyling: false,
                    showConfirmButton: false,
                    timer: 2000,
                    customClass: {
                        popup: "px-4 py-2 bg-white rounded-lg shadow-lg"
                    }
                });

                // Hide the modal after a short delay
                setTimeout(() => {
                    $('#kt_categories_export_modal').addClass('hidden').removeClass('flex justify-center items-center');
                }, 500); // Give SweetAlert time to show before closing modal
            });
        });
    </script>
}
